{% extends "base.html" %}

{% block title %}Resultado da Análise - SecureScan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Elemento oculto para armazenar os dados JSON -->
        <script type="application/json" id="result-data">
            {{ result | tojson }}
        </script>
        
        <div class="card shadow-lg border-0 rounded-lg mt-3">
            <div class="card-header bg-gradient text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="my-2"><i class="fas fa-clipboard-check"></i> Resultados da Análise</h3>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left"></i> Nova Análise
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Summary Section -->
                <div class="result-summary mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4>Arquivo: {{ result.file.name if result.file is defined and result.file.name is defined else "Nome não disponível" }}</h4>
                            <p class="mb-1"><strong>ID da Análise:</strong> {{ result.scan_id if result.scan_id is defined else "ID não disponível" }}</p>
                            <p class="mb-1"><strong>Data da Análise:</strong> {{ result.timestamp | replace('T', ' ') if result.timestamp is defined else "Data não disponível" }}</p>
                            
                            {% if result.summary is defined and result.summary.file_size is defined %}
                                <p class="mb-1"><strong>Tamanho do Arquivo:</strong> {{ (result.summary.file_size / 1024) | round(2) }} KB</p>
                            {% else %}
                                <p class="mb-1"><strong>Tamanho do Arquivo:</strong> Tamanho não disponível</p>
                            {% endif %}
                            
                            <p class="mb-1"><strong>Hash SHA-256:</strong> 
                                <span class="text-monospace small">{{ result.file.sha256 if result.file is defined and result.file.sha256 is defined else "Hash não disponível" }}</span>
                            </p>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="risk-assessment-container">
                                {% if result.summary is defined and result.summary.risk_assessment is defined %}
                                    <div class="risk-level risk-{{ result.summary.risk_assessment.color }}">
                                        <h2>{{ result.summary.risk_assessment.level }}</h2>
                                        <p>Taxa de Detecção: {{ result.summary.risk_assessment.detection_rate }}</p>
                                    </div>
                                {% else %}
                                    <div class="risk-level risk-gray">
                                        <h2>Indeterminado</h2>
                                        <p>Informações de risco não disponíveis</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Resumo de Detecção</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="detectionChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Status de Análise por Motores</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="engineStatusChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Results Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <h5 class="mb-0"><i class="fas fa-list-alt"></i> Resultados Detalhados</h5>
                        <div>
                            <button class="btn btn-sm btn-primary" id="filter-all">Todos</button>
                            <button class="btn btn-sm btn-outline-success" id="filter-clean">Limpos</button>
                            <button class="btn btn-sm btn-outline-danger" id="filter-infected">Detectados</button>
                            <button class="btn btn-sm btn-outline-secondary" id="filter-error">Erros</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="results-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Motor de Análise</th>
                                        <th>Status</th>
                                        <th>Resultado</th>
                                        <th>Ameaça Detectada</th>
                                        <th>Tempo (s)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if result.engines is defined %}
                                        {% for engine_name, details in result.engines.items() %}
                                        <tr class="result-row {{ 'clean' if details.result == 'Clean' else 'infected' if details.result == 'Infected' else 'error' }}">
                                            <td><strong>{{ engine_name }}</strong></td>
                                            <td>
                                                {% if details.status == "completed" %}
                                                    <span class="badge bg-success">Completo</span>
                                                {% elif details.status == "timeout" %}
                                                    <span class="badge bg-warning">Timeout</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Erro</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if details.result == "Clean" %}
                                                    <span class="text-success"><i class="fas fa-shield-check"></i> Limpo</span>
                                                {% elif details.result == "Infected" %}
                                                    <span class="text-danger"><i class="fas fa-virus"></i> Infectado</span>
                                                {% else %}
                                                    <span class="text-secondary"><i class="fas fa-question-circle"></i> Desconhecido</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ details.threat_name if details.threat_name else "-" }}</td>
                                            <td>{{ details.scan_time | round(2) }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center">Nenhum dado de análise disponível</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg d-block">
                            <i class="fas fa-upload"></i> Analisar Outro Arquivo
                        </a>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button id="download-report" class="btn btn-success btn-lg d-block">
                            <i class="fas fa-file-download"></i> Baixar Relatório PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Abordagem alternativa: armazenar os dados em um elemento HTML
        // e então recuperá-los usando JavaScript
        const resultDataElement = document.getElementById('result-data');
        const resultData = JSON.parse(resultDataElement.textContent);
        
        // Verificar se os dados necessários existem antes de criar os gráficos
        if (resultData && resultData.summary) {
            // Set up detection summary chart
            const detectionCtx = document.getElementById('detectionChart').getContext('2d');
            const detectionChart = new Chart(detectionCtx, {
                type: 'pie',
                data: {
                    labels: ['Limpo', 'Infectado', 'Erro/Desconhecido'],
                    datasets: [{
                        data: [
                            resultData.summary.clean_engines || 0,
                            resultData.summary.detected_threats || 0,
                            resultData.summary.error_engines || 0
                        ],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',  // Green for clean
                            'rgba(220, 53, 69, 0.7)',  // Red for infected
                            'rgba(108, 117, 125, 0.7)' // Gray for errors
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(108, 117, 125, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Set up engine status chart
            if (resultData.engines) {
                const engineStatusCtx = document.getElementById('engineStatusChart').getContext('2d');
                const engineStatusChart = new Chart(engineStatusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Completados', 'Timeout', 'Erro'],
                        datasets: [{
                            label: 'Status dos Motores de Análise',
                            data: [
                                Object.values(resultData.engines).filter(e => e && e.status === 'completed').length,
                                Object.values(resultData.engines).filter(e => e && e.status === 'timeout').length,
                                Object.values(resultData.engines).filter(e => e && e.status === 'error').length
                            ],
                            backgroundColor: [
                                'rgba(32, 201, 151, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ],
                            borderColor: [
                                'rgba(32, 201, 151, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } else {
                console.error("Dados de motores não encontrados");
                document.getElementById('engineStatusChart').parentNode.innerHTML = 
                    '<div class="alert alert-warning">Dados de status dos motores não disponíveis</div>';
            }
        } else {
            console.error("Dados de resumo não encontrados");
            document.getElementById('detectionChart').parentNode.innerHTML = 
                '<div class="alert alert-warning">Dados de detecção não disponíveis</div>';
            document.getElementById('engineStatusChart').parentNode.innerHTML = 
                '<div class="alert alert-warning">Dados de status dos motores não disponíveis</div>';
        }
        
        // Filter functionality for results table
        const filterAll = document.getElementById('filter-all');
        const filterClean = document.getElementById('filter-clean');
        const filterInfected = document.getElementById('filter-infected');
        const filterError = document.getElementById('filter-error');
        const resultRows = document.querySelectorAll('.result-row');
        
        if (filterAll && filterClean && filterInfected && filterError) {
            filterAll.addEventListener('click', function() {
                setActiveFilter(this);
                resultRows.forEach(row => {
                    row.style.display = '';
                });
            });
            
            filterClean.addEventListener('click', function() {
                setActiveFilter(this);
                resultRows.forEach(row => {
                    if (row.classList.contains('clean')) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
            
            filterInfected.addEventListener('click', function() {
                setActiveFilter(this);
                resultRows.forEach(row => {
                    if (row.classList.contains('infected')) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
            
            filterError.addEventListener('click', function() {
                setActiveFilter(this);
                resultRows.forEach(row => {
                    if (row.classList.contains('error')) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
            
            function setActiveFilter(activeButton) {
                [filterAll, filterClean, filterInfected, filterError].forEach(btn => {
                    if (btn === activeButton) {
                        btn.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-danger', 'btn-outline-secondary');
                        btn.classList.add(
                            btn.id === 'filter-all' ? 'btn-primary' : 
                            btn.id === 'filter-clean' ? 'btn-success' : 
                            btn.id === 'filter-infected' ? 'btn-danger' : 'btn-secondary'
                        );
                    } else {
                        btn.className = btn.className.replace('btn-primary', 'btn-outline-primary')
                                                   .replace('btn-success', 'btn-outline-success')
                                                   .replace('btn-danger', 'btn-outline-danger')
                                                   .replace('btn-secondary', 'btn-outline-secondary');
                    }
                });
            }
        }
        
        // PDF Download functionality (simplified - would require a PDF generation library in production)
        const downloadBtn = document.getElementById('download-report');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                alert('Em um sistema real, esta funcionalidade geraria um PDF com o relatório completo da análise.');
                // In a real implementation, you would use a library like jsPDF or make a backend request to generate a PDF
            });
        }
    });
</script>
{% endblock %}